<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Chat App - Mobile Responsive</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        overflow: hidden;
      }

      .chat-container {
        width: 100%;
        height: 100vh;
        background: white;
        display: flex;
        position: relative;
      }

      /* Mobile-first sidebar */
      .sidebar {
        width: 280px;
        background: #2c3e50;
        color: white;
        padding: 15px;
        overflow-y: auto;
        position: absolute;
        left: -280px;
        top: 0;
        height: 100%;
        z-index: 1000;
        transition: left 0.3s ease;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #34495e;
      }

      .close-sidebar {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
      }

      .sidebar h3 {
        margin-bottom: 15px;
        color: #ecf0f1;
        font-size: 16px;
      }

      .room-item {
        padding: 12px 15px;
        margin: 8px 0;
        background: #34495e;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        display: flex;
        align-items: center;
      }

      .room-item:hover {
        background: #4a5f7a;
      }

      .room-item.active {
        background: #3498db;
      }

      .room-item::before {
        content: "#";
        margin-right: 8px;
        opacity: 0.7;
      }

      .users-list {
        margin-top: 25px;
      }

      .user-item {
        padding: 8px 15px;
        margin: 5px 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 13px;
        display: flex;
        align-items: center;
      }

      .user-item::before {
        content: "‚óè";
        color: #2ecc71;
        margin-right: 8px;
        font-size: 12px;
      }

      .main-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      .chat-header {
        background: #3498db;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 60px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .menu-toggle {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
      }

      .menu-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .header-info {
        flex: 1;
        text-align: center;
      }

      .header-info h3 {
        font-size: 18px;
        margin-bottom: 2px;
      }

      .header-info span {
        font-size: 12px;
        opacity: 0.9;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
        -webkit-overflow-scrolling: touch;
      }

      .message {
        margin-bottom: 15px;
        padding: 12px 15px;
        border-radius: 15px;
        max-width: 85%;
        animation: slideIn 0.3s ease-out;
        word-wrap: break-word;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.own {
        background: #3498db;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
      }

      .message.other {
        background: white;
        color: #333;
        border: 1px solid #e1e8ed;
        border-bottom-left-radius: 5px;
      }

      .message-header {
        font-size: 11px;
        opacity: 0.8;
        margin-bottom: 6px;
        font-weight: 500;
      }

      .message-content {
        word-wrap: break-word;
        line-height: 1.4;
      }

      .media-message {
        max-width: 95%;
      }

      .media-content {
        margin-top: 10px;
      }

      .media-content img {
        max-width: 100%;
        max-height: 250px;
        border-radius: 8px;
        cursor: pointer;
        display: block;
      }

      .media-content video {
        max-width: 100%;
        max-height: 250px;
        border-radius: 8px;
      }

      .media-content audio {
        width: 100%;
        margin: 8px 0;
      }

      .file-message {
        display: flex;
        align-items: center;
        padding: 12px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        margin-top: 8px;
      }

      .file-icon {
        font-size: 20px;
        margin-right: 12px;
      }

      .file-info {
        flex: 1;
        min-width: 0;
      }

      .file-name {
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .file-size {
        font-size: 11px;
        opacity: 0.7;
      }

      .system-message {
        text-align: center;
        color: #7f8c8d;
        font-style: italic;
        margin: 15px 0;
        font-size: 13px;
      }

      .typing-indicator {
        color: #7f8c8d;
        font-style: italic;
        padding: 8px 20px;
        font-size: 13px;
        min-height: 30px;
      }

      .input-area {
        background: white;
        border-top: 1px solid #e1e8ed;
        padding: 15px;
        padding-bottom: calc(15px + env(safe-area-inset-bottom));
      }

      .input-group {
        display: flex;
        gap: 8px;
        align-items: flex-end;
      }

      .message-input {
        flex: 1;
        border: 2px solid #e1e8ed;
        border-radius: 20px;
        padding: 12px 16px;
        font-size: 16px;
        resize: none;
        max-height: 100px;
        outline: none;
        transition: border-color 0.3s;
        font-family: inherit;
      }

      .message-input:focus {
        border-color: #3498db;
      }

      .input-buttons {
        display: flex;
        gap: 8px;
      }

      .btn {
        width: 44px;
        height: 44px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-secondary {
        background: #95a5a6;
        color: white;
      }

      .btn:hover {
        transform: scale(1.1);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .file-input {
        display: none;
      }

      .upload-progress {
        margin: 10px 15px;
        padding: 12px;
        background: #e8f5e8;
        border-radius: 8px;
        display: none;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #ddd;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 8px;
      }

      .progress-fill {
        height: 100%;
        background: #27ae60;
        width: 0%;
        transition: width 0.3s;
      }

      .login-form {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
      }

      .login-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        text-align: center;
        width: 100%;
        max-width: 350px;
      }

      .login-box h2 {
        margin-bottom: 25px;
        color: #2c3e50;
        font-size: 24px;
      }

      .login-input {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
      }

      .login-input:focus {
        border-color: #3498db;
      }

      .login-btn {
        width: 100%;
        padding: 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 15px;
      }

      .login-btn:hover {
        background: #2980b9;
      }

      .error-message {
        color: #e74c3c;
        margin-top: 10px;
        font-size: 14px;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }

      .overlay.show {
        display: block;
      }

      /* Mobile optimizations */
      @media (max-width: 768px) {
        .chat-container {
          border-radius: 0;
        }

        .sidebar {
          width: 260px;
          left: -260px;
        }

        .message {
          max-width: 90%;
        }

        .media-message {
          max-width: 95%;
        }

        .login-box {
          margin: 20px;
          padding: 25px;
        }

        .input-area {
          padding: 12px;
          padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .message-input {
          font-size: 16px; /* Prevents zoom on iOS */
        }
      }

      /* iPhone X and newer safe areas */
      @media (max-width: 768px) and (orientation: portrait) {
        .chat-container {
          height: 100vh;
          height: -webkit-fill-available;
        }

        .input-area {
          padding-bottom: calc(15px + env(safe-area-inset-bottom));
        }
      }

      /* Landscape mobile */
      @media (max-width: 768px) and (orientation: landscape) {
        .chat-header {
          padding: 10px 15px;
          min-height: 50px;
        }

        .header-info h3 {
          font-size: 16px;
        }

        .input-area {
          padding: 10px;
        }
      }

      /* Very small screens */
      @media (max-width: 480px) {
        .sidebar {
          width: 240px;
          left: -240px;
        }

        .message {
          padding: 10px 12px;
          font-size: 14px;
        }

        .btn {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }

        .login-box {
          padding: 20px;
        }

        .login-box h2 {
          font-size: 20px;
        }
      }

      /* Touch improvements */
      @media (hover: none) and (pointer: coarse) {
        .btn:hover {
          transform: none;
        }

        .btn:active {
          transform: scale(0.95);
        }

        .room-item:hover {
          background: #34495e;
        }

        .room-item:active {
          background: #4a5f7a;
        }
      }

      /* High DPI screens */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .message {
          border-width: 0.5px;
        }
      }

      /* Dark mode support */
      @media (prefers-color-scheme: dark) {
        .messages-container {
          background: #1a1a1a;
        }

        .message.other {
          background: #2d2d2d;
          color: #fff;
          border-color: #444;
        }

        .input-area {
          background: #2d2d2d;
          border-color: #444;
        }

        .message-input {
          background: #1a1a1a;
          border-color: #444;
          color: #fff;
        }

        .message-input::placeholder {
          color: #aaa;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Form -->
    <div class="login-form" id="loginForm">
      <div class="login-box">
        <h2>Join Chat</h2>
        <input
          type="text"
          class="login-input"
          id="usernameInput"
          placeholder="Enter your username"
          maxlength="20"
        />
        <input
          type="text"
          class="login-input"
          id="roomInput"
          placeholder="Enter room name"
          value="general"
        />
        <button class="login-btn" onclick="joinChat()">Join Chat</button>
        <div class="error-message" id="errorMessage"></div>
      </div>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <!-- Main Chat Interface -->
    <div class="chat-container" id="chatContainer" style="display: none">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h3>üí¨ Chat Rooms</h3>
          <button class="close-sidebar" onclick="closeSidebar()">√ó</button>
        </div>

        <div class="room-item active" data-room="general">General</div>
        <div class="room-item" data-room="tech">Tech Talk</div>
        <div class="room-item" data-room="random">Random</div>
        <div class="room-item" data-room="gaming">Gaming</div>

        <div class="users-list">
          <h3>üë• Online Users</h3>
          <div id="usersList"></div>
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="main-chat">
        <div class="chat-header">
          <button class="menu-toggle" onclick="openSidebar()">‚ò∞</button>
          <div class="header-info">
            <h3 id="currentRoom">General Chat</h3>
            <span id="userCount">0 users</span>
          </div>
          <div style="width: 40px"></div>
          <!-- Spacer for centering -->
        </div>

        <div class="messages-container" id="messagesContainer">
          <!-- Messages will appear here -->
        </div>

        <div class="typing-indicator" id="typingIndicator"></div>

        <div class="upload-progress" id="uploadProgress">
          <div>Uploading file...</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <div class="input-area">
          <div class="input-group">
            <textarea
              class="message-input"
              id="messageInput"
              placeholder="Type a message..."
              rows="1"
            ></textarea>

            <div class="input-buttons">
              <input
                type="file"
                class="file-input"
                id="fileInput"
                accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"
              />
              <button
                class="btn btn-secondary"
                onclick="document.getElementById('fileInput').click()"
                title="Attach file"
              >
                üìé
              </button>
              <button
                class="btn btn-primary"
                id="sendButton"
                onclick="sendMessage()"
                title="Send message"
              >
                ‚û§
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let socket;
      let currentUser = null;
      let currentRoom = "general";
      let typingTimer;
      let isTyping = false;

      // Mobile-specific functions
      function openSidebar() {
        document.getElementById("sidebar").classList.add("open");
        document.getElementById("overlay").classList.add("show");
        document.body.style.overflow = "hidden";
      }

      function closeSidebar() {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("overlay").classList.remove("show");
        document.body.style.overflow = "";
      }

      // Initialize socket connection
      function initSocket() {
        socket = io();

        socket.on("connect", () => {
          console.log("Connected to server");
        });

        socket.on("disconnect", () => {
          console.log("Disconnected from server");
        });

        socket.on("new-message", (message) => {
          displayMessage(message);
        });

        socket.on("user-joined", (data) => {
          displaySystemMessage(data.message);
        });

        socket.on("user-left", (data) => {
          displaySystemMessage(data.message);
        });

        socket.on("room-users", (users) => {
          updateUsersList(users);
        });

        socket.on("user-typing", (data) => {
          showTypingIndicator(`${data.username} is typing...`);
        });

        socket.on("user-stopped-typing", (data) => {
          hideTypingIndicator();
        });
      }

      // Join chat function
      function joinChat() {
        const username = document.getElementById("usernameInput").value.trim();
        const room =
          document.getElementById("roomInput").value.trim() || "general";
        const errorEl = document.getElementById("errorMessage");

        if (!username) {
          errorEl.textContent = "Please enter a username";
          return;
        }

        if (username.length < 2) {
          errorEl.textContent = "Username must be at least 2 characters";
          return;
        }

        currentUser = username;
        currentRoom = room;

        initSocket();
        socket.emit("join", { username, room });

        document.getElementById("loginForm").style.display = "none";
        document.getElementById("chatContainer").style.display = "flex";

        updateRoomDisplay();
        document.getElementById("messageInput").focus();

        // Prevent zoom on input focus (iOS)
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          const messageInput = document.getElementById("messageInput");
          messageInput.addEventListener("focus", () => {
            messageInput.style.fontSize = "16px";
          });
        }
      }

      // Send message function
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message) return;

        socket.emit("send-message", { text: message });
        input.value = "";
        autoResize(input);

        if (isTyping) {
          socket.emit("stop-typing");
          isTyping = false;
        }

        // Close sidebar on mobile after sending
        if (window.innerWidth <= 768) {
          closeSidebar();
        }
      }

      // Display message in chat
      function displayMessage(message) {
        const container = document.getElementById("messagesContainer");
        const messageEl = document.createElement("div");
        const isOwn = message.username === currentUser;

        messageEl.className = `message ${isOwn ? "own" : "other"} ${
          message.type === "media" ? "media-message" : ""
        }`;

        const timestamp = new Date(message.timestamp).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        let content = "";

        if (message.type === "text") {
          content = `
                    <div class="message-header">${
                      message.username
                    } ‚Ä¢ ${timestamp}</div>
                    <div class="message-content">${escapeHtml(
                      message.text
                    )}</div>
                `;
        } else if (message.type === "media") {
          const media = message.media;
          let mediaContent = "";

          if (media.mimetype.startsWith("image/")) {
            mediaContent = `<img src="${media.url}" alt="${media.originalname}" onclick="openImageModal('${media.url}')">`;
          } else if (media.mimetype.startsWith("video/")) {
            mediaContent = `<video controls><source src="${media.url}" type="${media.mimetype}"></video>`;
          } else if (media.mimetype.startsWith("audio/")) {
            mediaContent = `<audio controls><source src="${media.url}" type="${media.mimetype}"></audio>`;
          } else {
            mediaContent = `
                        <div class="file-message">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-info">
                                <div class="file-name">${
                                  media.originalname
                                }</div>
                                <div class="file-size">${formatFileSize(
                                  media.size
                                )}</div>
                            </div>
                            <a href="${media.url}" download="${
              media.originalname
            }" style="color: inherit;">‚¨áÔ∏è</a>
                        </div>
                    `;
          }

          content = `
                    <div class="message-header">${
                      message.username
                    } ‚Ä¢ ${timestamp}</div>
                    ${
                      message.caption
                        ? `<div class="message-content">${escapeHtml(
                            message.caption
                          )}</div>`
                        : ""
                    }
                    <div class="media-content">${mediaContent}</div>
                `;
        }

        messageEl.innerHTML = content;
        container.appendChild(messageEl);
        container.scrollTop = container.scrollHeight;
      }

      // Display system message
      function displaySystemMessage(text) {
        const container = document.getElementById("messagesContainer");
        const messageEl = document.createElement("div");
        messageEl.className = "system-message";
        messageEl.textContent = text;
        container.appendChild(messageEl);
        container.scrollTop = container.scrollHeight;
      }

      // Handle file upload
      document
        .getElementById("fileInput")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // Check file size (mobile users might have limited data)
          if (file.size > 10 * 1024 * 1024) {
            // 10MB limit for mobile
            alert("File too large. Please choose a file under 10MB.");
            e.target.value = "";
            return;
          }

          const formData = new FormData();
          formData.append("media", file);

          const progressEl = document.getElementById("uploadProgress");
          const progressFill = document.getElementById("progressFill");

          progressEl.style.display = "block";

          try {
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener("progress", (e) => {
              if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressFill.style.width = percentComplete + "%";
              }
            });

            xhr.open("POST", "/upload");

            xhr.onload = function () {
              progressEl.style.display = "none";

              if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);

                socket.emit("send-media", {
                  url: response.file.url,
                  filename: response.file.filename,
                  originalname: response.file.originalname,
                  mimetype: response.file.mimetype,
                  size: response.file.size,
                  caption: "",
                });

                e.target.value = "";
              } else {
                alert("Upload failed. Please try again.");
              }
            };

            xhr.onerror = function () {
              progressEl.style.display = "none";
              alert("Upload failed. Please check your connection.");
            };

            xhr.send(formData);
          } catch (error) {
            console.error("Upload error:", error);
            progressEl.style.display = "none";
            alert("Upload failed. Please try again.");
          }
        });

      // Room switching
      document.querySelectorAll(".room-item").forEach((item) => {
        item.addEventListener("click", () => {
          const room = item.dataset.room;
          switchRoom(room);
          closeSidebar(); // Close sidebar on mobile
        });
      });

      function switchRoom(room) {
        if (room === currentRoom) return;

        currentRoom = room;
        socket.emit("switch-room", room);

        document.querySelectorAll(".room-item").forEach((item) => {
          item.classList.remove("active");
        });
        document.querySelector(`[data-room="${room}"]`).classList.add("active");

        document.getElementById("messagesContainer").innerHTML = "";
        updateRoomDisplay();
      }

      function updateRoomDisplay() {
        const roomName =
          currentRoom.charAt(0).toUpperCase() + currentRoom.slice(1);
        document.getElementById("currentRoom").textContent = roomName + " Chat";
      }

      // Update users list
      function updateUsersList(users) {
        const usersList = document.getElementById("usersList");
        const userCount = document.getElementById("userCount");

        usersList.innerHTML = "";
        users.forEach((user) => {
          const userEl = document.createElement("div");
          userEl.className = "user-item";
          userEl.textContent = user.username;
          usersList.appendChild(userEl);
        });

        userCount.textContent = `${users.length} user${
          users.length !== 1 ? "s" : ""
        }`;
      }

      // Typing indicators
      function showTypingIndicator(text) {
        document.getElementById("typingIndicator").textContent = text;
      }

      function hideTypingIndicator() {
        document.getElementById("typingIndicator").textContent = "";
      }

      // Message input handling
      const messageInput = document.getElementById("messageInput");

      messageInput.addEventListener("input", (e) => {
        autoResize(e.target);

        if (!isTyping && e.target.value.trim()) {
          socket.emit("typing");
          isTyping = true;
        }

        clearTimeout(typingTimer);

        typingTimer = setTimeout(() => {
          if (isTyping) {
            socket.emit("stop-typing");
            isTyping = false;
          }
        }, 1000);
      });

      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      function autoResize(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + "px";
      }

      // Utility functions
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function openImageModal(src) {
        // Create modal for full-size image viewing
        const modal = document.createElement("div");
        modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); display: flex; align-items: center;
                justify-content: center; z-index: 9999; cursor: pointer;
                padding: 20px;
            `;

        const img = document.createElement("img");
        img.src = src;
        img.style.cssText = `
                max-width: 100%; max-height: 100%; border-radius: 8px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;

        modal.appendChild(img);
        document.body.appendChild(modal);

        modal.addEventListener("click", () => {
          document.body.removeChild(modal);
        });

        // Close on escape key
        const handleEscape = (e) => {
          if (e.key === "Escape") {
            document.body.removeChild(modal);
            document.removeEventListener("keydown", handleEscape);
          }
        };
        document.addEventListener("keydown", handleEscape);
      }

      // Mobile-specific optimizations
      function handleMobileViewport() {
        // Fix viewport height on mobile browsers
        const setVH = () => {
          let vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty("--vh", `${vh}px`);
        };

        setVH();
        window.addEventListener("resize", setVH);
        window.addEventListener("orientationchange", () => {
          setTimeout(setVH, 100);
        });
      }

      // Prevent zoom on input focus (iOS Safari)
      function preventZoomOnInput() {
        const inputs = document.querySelectorAll("input, textarea");
        inputs.forEach((input) => {
          input.addEventListener("focus", () => {
            if (input.style.fontSize !== "16px") {
              input.style.fontSize = "16px";
            }
          });
        });
      }

      // Handle touch events for better mobile experience
      function initTouchHandlers() {
        let touchStartY = 0;
        const messagesContainer = document.getElementById("messagesContainer");

        // Pull to refresh (optional feature)
        messagesContainer.addEventListener("touchstart", (e) => {
          touchStartY = e.touches[0].clientY;
        });

        messagesContainer.addEventListener("touchmove", (e) => {
          const touchY = e.touches[0].clientY;
          const touchDiff = touchY - touchStartY;

          // If scrolled to top and pulling down
          if (messagesContainer.scrollTop === 0 && touchDiff > 0) {
            // Could implement pull to refresh here
          }
        });

        // Close sidebar when tapping outside
        document.addEventListener("touchstart", (e) => {
          const sidebar = document.getElementById("sidebar");
          const menuToggle = document.querySelector(".menu-toggle");

          if (
            sidebar.classList.contains("open") &&
            !sidebar.contains(e.target) &&
            !menuToggle.contains(e.target)
          ) {
            closeSidebar();
          }
        });
      }

      // Auto-scroll to bottom when keyboard appears on mobile
      function handleKeyboardAppearance() {
        const messageInput = document.getElementById("messageInput");
        const messagesContainer = document.getElementById("messagesContainer");

        messageInput.addEventListener("focus", () => {
          // Delay to ensure keyboard is shown
          setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }, 300);
        });

        messageInput.addEventListener("blur", () => {
          // Scroll to bottom when keyboard hides
          setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }, 300);
        });
      }

      // Connection status indicator
      function initConnectionStatus() {
        const createStatusIndicator = () => {
          const indicator = document.createElement("div");
          indicator.id = "connectionStatus";
          indicator.style.cssText = `
                    position: fixed; top: 60px; right: 15px; z-index: 1001;
                    background: #e74c3c; color: white; padding: 5px 10px;
                    border-radius: 15px; font-size: 12px; display: none;
                    animation: fadeIn 0.3s ease-in;
                `;
          document.body.appendChild(indicator);
          return indicator;
        };

        const statusIndicator = createStatusIndicator();

        if (socket) {
          socket.on("connect", () => {
            statusIndicator.style.display = "none";
          });

          socket.on("disconnect", () => {
            statusIndicator.textContent = "Disconnected";
            statusIndicator.style.background = "#e74c3c";
            statusIndicator.style.display = "block";
          });

          socket.on("reconnecting", (attemptNumber) => {
            statusIndicator.textContent = `Reconnecting... (${attemptNumber})`;
            statusIndicator.style.background = "#f39c12";
            statusIndicator.style.display = "block";
          });

          socket.on("reconnect", () => {
            statusIndicator.textContent = "Reconnected";
            statusIndicator.style.background = "#27ae60";
            statusIndicator.style.display = "block";

            setTimeout(() => {
              statusIndicator.style.display = "none";
            }, 2000);
          });
        }
      }

      // PWA-like experience
      function initPWAFeatures() {
        // Add to home screen prompt
        let deferredPrompt;

        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;

          // Show custom install button (optional)
          const installButton = document.createElement("button");
          installButton.textContent = "üì± Install App";
          installButton.style.cssText = `
                    position: fixed; bottom: 20px; right: 20px;
                    background: #3498db; color: white; border: none;
                    padding: 10px 15px; border-radius: 20px; font-size: 12px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000;
                `;

          installButton.addEventListener("click", () => {
            if (deferredPrompt) {
              deferredPrompt.prompt();
              deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === "accepted") {
                  console.log("User accepted the install prompt");
                }
                deferredPrompt = null;
                document.body.removeChild(installButton);
              });
            }
          });

          document.body.appendChild(installButton);

          // Auto-hide after 10 seconds
          setTimeout(() => {
            if (document.body.contains(installButton)) {
              document.body.removeChild(installButton);
            }
          }, 10000);
        });

        // Hide install button after installation
        window.addEventListener("appinstalled", (evt) => {
          console.log("App installed");
        });
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("usernameInput").focus();

        // Initialize mobile-specific features
        handleMobileViewport();
        preventZoomOnInput();
        initTouchHandlers();
        handleKeyboardAppearance();
        initPWAFeatures();

        // Add CSS for mobile viewport fix
        const style = document.createElement("style");
        style.textContent = `
                .chat-container {
                    height: 100vh;
                    height: calc(var(--vh, 1vh) * 100);
                }
            `;
        document.head.appendChild(style);

        // Handle online/offline status
        window.addEventListener("online", () => {
          console.log("Back online");
          if (socket && !socket.connected) {
            socket.connect();
          }
        });

        window.addEventListener("offline", () => {
          console.log("Gone offline");
        });
      });

      // Handle page visibility change (mobile app switching)
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          // App went to background
          if (isTyping && socket) {
            socket.emit("stop-typing");
            isTyping = false;
          }
        } else {
          // App came to foreground
          const messagesContainer =
            document.getElementById("messagesContainer");
          if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
        }
      });

      // Initialize connection status after socket is created
      function initConnectionStatusAfterSocket() {
        if (socket) {
          initConnectionStatus();
        }
      }

      // Call this after socket initialization
      window.addEventListener("load", () => {
        // Small delay to ensure everything is loaded
        setTimeout(() => {
          if (socket) {
            initConnectionStatusAfterSocket();
          }
        }, 1000);
      });
    </script>
  </body>
</html>
